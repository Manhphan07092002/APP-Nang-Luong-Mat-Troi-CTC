<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt Lại Mật Khẩu - SolarAnalytics</title>
    <link rel="icon" type="image/png" href="/assets/images/logo_rm_bgr.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/auth.css">
    <link rel="stylesheet" href="/assets/css/modern-design.css">
</head>
<body class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 via-white to-cyan-50">
    <div class="w-full max-w-md p-4 fade-in">
        <!-- Modern Logo Section -->
        <div class="text-center mb-8">
            <a href="/" class="inline-flex items-center gap-3 hover-lift">
                <div class="w-12 h-12 bg-gradient-primary rounded-xl flex items-center justify-center">
                    <i class="fas fa-solar-panel text-white text-xl"></i>
                </div>
                <span class="text-3xl font-bold text-gradient">SolarAnalytics</span>
            </a>
            <p class="text-gray-600 mt-2">Hệ thống phân tích năng lượng mặt trời</p>
        </div>

        <!-- Reset Password Form -->
        <div class="modern-card p-8 scale-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-lock text-white text-2xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-gradient mb-2">Đặt Lại Mật Khẩu</h2>
                <p class="text-gray-600">Tạo mật khẩu mới cho tài khoản của bạn</p>
            </div>
            
            <!-- Success Message -->
            <div id="success-message" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg relative mb-6 text-sm" role="alert">
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <div>
                        <strong class="font-bold">Thành công!</strong>
                        <span class="block sm:inline ml-1" id="success-text">Mật khẩu đã được đặt lại thành công.</span>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg relative mb-6 text-sm" role="alert">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <div>
                        <strong class="font-bold">Lỗi!</strong>
                        <span class="block sm:inline ml-1" id="error-text">Nội dung lỗi sẽ hiện ở đây.</span>
                    </div>
                </div>
            </div>

            <!-- Token Validation State -->
            <div id="validating-token" class="text-center space-y-4">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto">
                    <i class="fas fa-spinner fa-spin text-blue-600 text-xl"></i>
                </div>
                <p class="text-gray-600">Đang xác thực liên kết đặt lại mật khẩu...</p>
            </div>

            <!-- Reset Form -->
            <div id="reset-form" class="hidden space-y-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800 mb-6">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle mr-2 mt-0.5"></i>
                        <div>
                            <p class="font-semibold mb-1">Đang đặt lại mật khẩu cho:</p>
                            <p id="reset-email" class="font-mono"></p>
                        </div>
                    </div>
                </div>

                <form id="reset-password-form" novalidate>
                    <div class="form-group">
                        <label class="form-label" for="newPassword">
                            <i class="fas fa-key mr-2"></i>
                            Mật khẩu mới
                        </label>
                        <div class="relative">
                            <input class="form-input pr-12" id="newPassword" type="password" placeholder="••••••••••" required minlength="6">
                            <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600" onclick="togglePassword('newPassword', 'new-password-toggle')">
                                <i class="fas fa-eye" id="new-password-toggle"></i>
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">Mật khẩu phải có ít nhất 6 ký tự</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">
                            <i class="fas fa-check-double mr-2"></i>
                            Xác nhận mật khẩu
                        </label>
                        <div class="relative">
                            <input class="form-input pr-12" id="confirmPassword" type="password" placeholder="••••••••••" required minlength="6">
                            <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600" onclick="togglePassword('confirmPassword', 'confirm-password-toggle')">
                                <i class="fas fa-eye" id="confirm-password-toggle"></i>
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">Nhập lại mật khẩu để xác nhận</p>
                    </div>

                    <!-- Password Strength Indicator -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm">
                        <p class="font-semibold text-gray-700 mb-2">Yêu cầu mật khẩu:</p>
                        <ul class="space-y-1">
                            <li class="flex items-center" id="length-check">
                                <i class="fas fa-times text-red-500 mr-2 w-4"></i>
                                <span>Ít nhất 6 ký tự</span>
                            </li>
                            <li class="flex items-center" id="match-check">
                                <i class="fas fa-times text-red-500 mr-2 w-4"></i>
                                <span>Mật khẩu xác nhận khớp</span>
                            </li>
                        </ul>
                    </div>
                    
                    <button id="submit-btn" class="btn-modern btn-primary w-full text-lg py-4" type="submit">
                        <i class="fas fa-save mr-2"></i>
                        <span id="submit-text">Đặt Lại Mật Khẩu</span>
                        <i class="fas fa-spinner fa-spin ml-2 hidden" id="submit-spinner"></i>
                    </button>
                </form>
            </div>

            <!-- Success State -->
            <div id="success-state" class="hidden text-center space-y-6">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto">
                    <i class="fas fa-check text-green-600 text-3xl"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Thành công!</h3>
                    <p class="text-gray-600 mb-4">Mật khẩu của bạn đã được đặt lại thành công. Bạn có thể đăng nhập với mật khẩu mới.</p>
                    
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6 text-sm">
                        <div class="flex items-center text-green-800">
                            <i class="fas fa-shield-alt mr-2"></i>
                            <div class="text-left">
                                <p class="font-semibold">Bảo mật tài khoản:</p>
                                <ul class="mt-1 space-y-1 text-green-700">
                                    <li>• Mật khẩu đã được mã hóa an toàn</li>
                                    <li>• Tất cả phiên đăng nhập cũ đã bị hủy</li>
                                    <li>• Hãy đăng nhập lại để tiếp tục</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <a href="/login.html" class="btn-modern btn-primary inline-flex items-center">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        Đăng nhập ngay
                    </a>
                </div>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden text-center space-y-6">
                <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto">
                    <i class="fas fa-exclamation-triangle text-red-600 text-3xl"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Liên kết không hợp lệ</h3>
                    <p class="text-gray-600 mb-4" id="error-state-message">Liên kết đặt lại mật khẩu đã hết hạn hoặc không hợp lệ</p>
                </div>
                <div class="space-y-3">
                    <a href="/forgot-password.html" class="btn-modern btn-primary w-full inline-flex items-center justify-center">
                        <i class="fas fa-redo mr-2"></i>
                        Yêu cầu liên kết mới
                    </a>
                    <a href="/login.html" class="btn-modern btn-outline w-full inline-flex items-center justify-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Quay lại đăng nhập
                    </a>
                </div>
            </div>
        </div>

        <!-- Help Section -->
        <div class="mt-8 text-center">
            <div class="glass-effect p-6 rounded-lg">
                <h3 class="font-semibold text-gray-900 mb-2">Cần hỗ trợ?</h3>
                <p class="text-gray-600 text-sm mb-4">Nếu bạn gặp khó khăn trong việc đặt lại mật khẩu</p>
                <div class="flex justify-center space-x-4">
                    <a href="mailto:support@solaranalytics.com" class="text-blue-600 hover:text-blue-800 text-sm">
                        <i class="fas fa-envelope mr-1"></i>
                        Email hỗ trợ
                    </a>
                    <a href="tel:0979900874" class="text-blue-600 hover:text-blue-800 text-sm">
                        <i class="fas fa-phone mr-1"></i>
                        Hotline: 097 99 00 874
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const email = urlParams.get('email');

        // Form elements
        const form = document.getElementById('reset-password-form');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const submitSpinner = document.getElementById('submit-spinner');
        
        // State elements
        const validatingToken = document.getElementById('validating-token');
        const resetForm = document.getElementById('reset-form');
        const successState = document.getElementById('success-state');
        const errorState = document.getElementById('error-state');
        const errorStateMessage = document.getElementById('error-state-message');
        const resetEmail = document.getElementById('reset-email');
        
        // Message elements
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');
        const successText = document.getElementById('success-text');
        const errorText = document.getElementById('error-text');

        // Password strength indicators
        const lengthCheck = document.getElementById('length-check');
        const matchCheck = document.getElementById('match-check');

        // Utility functions
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
        }

        function showSuccess(message) {
            successText.textContent = message;
            successMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }

        function hideMessages() {
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
        }

        function setLoading(loading) {
            if (loading) {
                submitBtn.disabled = true;
                submitText.textContent = 'Đang xử lý...';
                submitSpinner.classList.remove('hidden');
                submitBtn.classList.add('opacity-75');
            } else {
                submitBtn.disabled = false;
                submitText.textContent = 'Đặt Lại Mật Khẩu';
                submitSpinner.classList.add('hidden');
                submitBtn.classList.remove('opacity-75');
            }
        }

        function togglePassword(inputId, toggleId) {
            const input = document.getElementById(inputId);
            const toggle = document.getElementById(toggleId);
            
            if (input.type === 'password') {
                input.type = 'text';
                toggle.classList.remove('fa-eye');
                toggle.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                toggle.classList.remove('fa-eye-slash');
                toggle.classList.add('fa-eye');
            }
        }

        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input.trim()
                .replace(/[<>]/g, '') // Remove potential HTML tags
                .replace(/javascript:/gi, '') // Remove javascript: protocol
                .replace(/on\w+=/gi, ''); // Remove event handlers
        }

        function updatePasswordStrength() {
            const password = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            // Length check
            if (password.length >= 6) {
                lengthCheck.innerHTML = '<i class="fas fa-check text-green-500 mr-2 w-4"></i><span>Ít nhất 6 ký tự</span>';
            } else {
                lengthCheck.innerHTML = '<i class="fas fa-times text-red-500 mr-2 w-4"></i><span>Ít nhất 6 ký tự</span>';
            }
            
            // Match check
            if (confirmPassword && password === confirmPassword) {
                matchCheck.innerHTML = '<i class="fas fa-check text-green-500 mr-2 w-4"></i><span>Mật khẩu xác nhận khớp</span>';
            } else {
                matchCheck.innerHTML = '<i class="fas fa-times text-red-500 mr-2 w-4"></i><span>Mật khẩu xác nhận khớp</span>';
            }
        }

        function showState(state) {
            // Hide all states
            validatingToken.classList.add('hidden');
            resetForm.classList.add('hidden');
            successState.classList.add('hidden');
            errorState.classList.add('hidden');

            // Show requested state
            document.getElementById(state).classList.remove('hidden');
        }

        async function validateToken() {
            if (!token || !email) {
                showState('error-state');
                errorStateMessage.textContent = 'Liên kết không hợp lệ. Thiếu thông tin xác thực.';
                return;
            }

            try {
                // Validate token with server
                const response = await fetch('/api/auth/validate-reset-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        token: token,
                        email: decodeURIComponent(email)
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Token is valid - show form
                    resetEmail.textContent = decodeURIComponent(email);
                    showState('reset-form');
                    newPasswordInput.focus();
                } else {
                    // Token is invalid or expired
                    showState('error-state');
                    errorStateMessage.textContent = data.message || 'Liên kết đặt lại mật khẩu không hợp lệ hoặc đã hết hạn.';
                }
            } catch (error) {
                console.error('Token validation error:', error);
                showState('error-state');
                errorStateMessage.textContent = 'Không thể xác thực liên kết. Vui lòng thử lại sau.';
            }
        }

        // Form submission handler
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const newPassword = sanitizeInput(newPasswordInput.value);
            const confirmPassword = sanitizeInput(confirmPasswordInput.value);
            
            // Validation
            if (!newPassword || !confirmPassword) {
                showError('Vui lòng điền đầy đủ thông tin');
                return;
            }
            
            if (newPassword.length < 6) {
                showError('Mật khẩu phải có ít nhất 6 ký tự');
                newPasswordInput.focus();
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('Mật khẩu xác nhận không khớp');
                confirmPasswordInput.focus();
                return;
            }
            
            // Start loading
            setLoading(true);
            hideMessages();
            
            try {
                // Send reset password request with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        token: token,
                        email: decodeURIComponent(email),
                        newPassword: newPassword,
                        confirmPassword: confirmPassword
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Success - show success state
                    showState('success-state');
                    
                    // Log success for debugging
                    console.log('Password reset successful for:', decodeURIComponent(email));
                } else {
                    // Error from server
                    showError(data.message || 'Có lỗi xảy ra khi đặt lại mật khẩu');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showError('Yêu cầu quá thời gian chờ. Vui lòng kiểm tra kết nối và thử lại.');
                } else {
                    console.error('Reset password error:', error);
                    showError('Không thể kết nối đến server. Vui lòng thử lại sau.');
                }
            } finally {
                setLoading(false);
            }
        });

        // Password input event listeners
        newPasswordInput.addEventListener('input', updatePasswordStrength);
        confirmPasswordInput.addEventListener('input', updatePasswordStrength);

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            validateToken();
        });

        // Make togglePassword globally available
        window.togglePassword = togglePassword;
    </script>
</body>
</html>
