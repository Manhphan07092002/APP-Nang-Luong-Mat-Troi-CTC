<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quên Mật Khẩu - SolarAnalytics</title>
    <link rel="icon" type="image/png" href="/assets/images/logo_rm_bgr.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/auth.css">
    <link rel="stylesheet" href="/assets/css/modern-design.css">
</head>
<body class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 via-white to-cyan-50">
    <div class="w-full max-w-md p-4 fade-in">
        <!-- Modern Logo Section -->
        <div class="text-center mb-8">
            <a href="/" class="inline-flex items-center gap-3 hover-lift">
                <div class="w-12 h-12 bg-gradient-primary rounded-xl flex items-center justify-center">
                    <i class="fas fa-solar-panel text-white text-xl"></i>
                </div>
                <span class="text-3xl font-bold text-gradient">SolarAnalytics</span>
            </a>
            <p class="text-gray-600 mt-2">Hệ thống phân tích năng lượng mặt trời</p>
        </div>

        <!-- Forgot Password Form -->
        <div class="modern-card p-8 scale-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-key text-white text-2xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-gradient mb-2">Quên Mật Khẩu</h2>
                <p class="text-gray-600">Nhập email để nhận liên kết đặt lại mật khẩu</p>
            </div>
            
            <!-- Success Message -->
            <div id="success-message" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg relative mb-6 text-sm" role="alert">
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <div>
                        <strong class="font-bold">Thành công!</strong>
                        <span class="block sm:inline ml-1" id="success-text">Email đặt lại mật khẩu đã được gửi.</span>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg relative mb-6 text-sm" role="alert">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <div>
                        <strong class="font-bold">Lỗi!</strong>
                        <span class="block sm:inline ml-1" id="error-text">Nội dung lỗi sẽ hiện ở đây.</span>
                    </div>
                </div>
            </div>

            <!-- Step 1: Request Reset -->
            <div id="step-1" class="space-y-6">
                <form id="forgot-password-form" novalidate>
                    <div class="form-group">
                        <label class="form-label" for="email">
                            <i class="fas fa-envelope mr-2"></i>
                            Địa chỉ Email
                        </label>
                        <input class="form-input" id="email" type="email" placeholder="email@example.com" required>
                        <p class="text-sm text-gray-500 mt-2">Chúng tôi sẽ gửi liên kết đặt lại mật khẩu đến email này</p>
                    </div>
                    
                    <button id="submit-btn" class="btn-modern btn-primary w-full text-lg py-4" type="submit">
                        <i class="fas fa-paper-plane mr-2"></i>
                        <span id="submit-text">Gửi Liên Kết Đặt Lại</span>
                        <i class="fas fa-spinner fa-spin ml-2 hidden" id="submit-spinner"></i>
                    </button>
                </form>
            </div>

            <!-- Step 2: Success State -->
            <div id="step-2" class="hidden text-center space-y-6">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto">
                    <i class="fas fa-envelope-open-text text-green-600 text-3xl"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Email Đã Được Gửi!</h3>
                    <p class="text-gray-600 mb-4">Chúng tôi đã gửi liên kết đặt lại mật khẩu đến email:</p>
                    <p class="font-semibold text-blue-600" id="sent-email"></p>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle mr-2 mt-0.5"></i>
                        <div>
                            <p class="font-semibold mb-1">Lưu ý:</p>
                            <ul class="list-disc list-inside space-y-1 text-left">
                                <li>Kiểm tra cả hộp thư spam/junk</li>
                                <li>Liên kết có hiệu lực trong 15 phút</li>
                                <li>Nếu không nhận được email, hãy thử lại</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <button id="resend-btn" class="btn-modern btn-outline w-full" onclick="resetForm()">
                    <i class="fas fa-redo mr-2"></i>
                    Gửi Lại Email
                </button>
                
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-600 mb-2">Không nhận được email?</p>
                    <div class="flex flex-col sm:flex-row gap-2 text-xs text-gray-500">
                        <span>• Kiểm tra thư mục spam</span>
                        <span>• Đợi vài phút để email được gửi</span>
                        <span>• Thử gửi lại</span>
                    </div>
                </div>
                
                <!-- Development Mode Reset Link -->
                <div id="dev-reset-link" class="hidden mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div class="flex items-start">
                        <i class="fas fa-code text-yellow-600 mr-2 mt-1"></i>
                        <div class="text-left">
                            <p class="font-semibold text-yellow-800 text-sm">Development Mode:</p>
                            <p class="text-yellow-700 text-xs mb-2">Email chưa được cấu hình. Sử dụng link dưới đây để test:</p>
                            <a id="dev-reset-url" href="#" class="text-blue-600 hover:text-blue-800 text-xs break-all font-mono bg-white px-2 py-1 rounded border">
                                Link sẽ hiện ở đây
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Back to Login -->
            <div class="text-center mt-6">
                <a href="/login.html" class="text-blue-600 hover:text-blue-800 font-medium inline-flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Quay lại đăng nhập
                </a>
            </div>
        </div>

        <!-- Help Section -->
        <div class="mt-8 text-center">
            <div class="glass-effect p-6 rounded-lg">
                <h3 class="font-semibold text-gray-900 mb-2">Cần hỗ trợ?</h3>
                <p class="text-gray-600 text-sm mb-4">Nếu bạn gặp khó khăn trong việc đặt lại mật khẩu</p>
                <div class="flex justify-center space-x-4">
                    <a href="mailto:support@solaranalytics.com" class="text-blue-600 hover:text-blue-800 text-sm">
                        <i class="fas fa-envelope mr-1"></i>
                        Email hỗ trợ
                    </a>
                    <a href="tel:0979900874" class="text-blue-600 hover:text-blue-800 text-sm">
                        <i class="fas fa-phone mr-1"></i>
                        Hotline: 097 99 00 874
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Form elements
        const form = document.getElementById('forgot-password-form');
        const emailInput = document.getElementById('email');
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const submitSpinner = document.getElementById('submit-spinner');
        
        // Message elements
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');
        const successText = document.getElementById('success-text');
        const errorText = document.getElementById('error-text');
        
        // Step elements
        const step1 = document.getElementById('step-1');
        const step2 = document.getElementById('step-2');
        const sentEmail = document.getElementById('sent-email');

        // Utility functions
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
        }

        function showSuccess(message) {
            successText.textContent = message;
            successMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }

        function hideMessages() {
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
        }

        function setLoading(loading) {
            if (loading) {
                submitBtn.disabled = true;
                submitText.textContent = 'Đang gửi...';
                submitSpinner.classList.remove('hidden');
                submitBtn.classList.add('opacity-75');
            } else {
                submitBtn.disabled = false;
                submitText.textContent = 'Gửi Liên Kết Đặt Lại';
                submitSpinner.classList.add('hidden');
                submitBtn.classList.remove('opacity-75');
            }
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input.trim()
                .replace(/[<>]/g, '') // Remove potential HTML tags
                .replace(/javascript:/gi, '') // Remove javascript: protocol
                .replace(/on\w+=/gi, ''); // Remove event handlers
        }

        function resetForm() {
            step1.classList.remove('hidden');
            step2.classList.add('hidden');
            emailInput.value = '';
            hideMessages();
            setLoading(false);
        }

        function showSuccessStep(email) {
            step1.classList.add('hidden');
            step2.classList.remove('hidden');
            sentEmail.textContent = email;
            hideMessages();
        }

        // Form submission handler
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = sanitizeInput(emailInput.value);
            
            // Validation
            if (!email) {
                showError('Vui lòng nhập địa chỉ email');
                emailInput.focus();
                return;
            }
            
            if (!validateEmail(email)) {
                showError('Vui lòng nhập địa chỉ email hợp lệ');
                emailInput.focus();
                return;
            }
            
            // Start loading
            setLoading(true);
            hideMessages();
            
            try {
                // Send forgot password request
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch('/api/auth/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ email }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Success - show step 2
                    showSuccessStep(email);
                    
                    // Show development reset link if email wasn't sent
                    if (data.resetUrl && !data.emailSent) {
                        const devResetLink = document.getElementById('dev-reset-link');
                        const devResetUrl = document.getElementById('dev-reset-url');
                        devResetUrl.href = data.resetUrl;
                        devResetUrl.textContent = data.resetUrl;
                        devResetLink.classList.remove('hidden');
                    }
                    
                    // Log success for debugging
                    console.log('Forgot password email sent successfully to:', email);
                } else {
                    // Error from server
                    showError(data.message || 'Có lỗi xảy ra khi gửi email đặt lại mật khẩu');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showError('Yêu cầu quá thời gian chờ. Vui lòng kiểm tra kết nối và thử lại.');
                } else {
                    console.error('Forgot password error:', error);
                    showError('Không thể kết nối đến server. Vui lòng thử lại sau.');
                }
            } finally {
                setLoading(false);
            }
        });

        // Auto-focus email input
        document.addEventListener('DOMContentLoaded', function() {
            emailInput.focus();
        });

        // Handle Enter key in email input
        emailInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                form.dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html>