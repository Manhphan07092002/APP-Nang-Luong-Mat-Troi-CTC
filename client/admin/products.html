<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Sản Phẩm - Admin SolarAnalytics</title>
    <link rel="icon" type="image/png" href="/assets/images/logo_rm_bgr.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="js/admin-auth.js" defer></script>
    <script src="js/sidebar-loader.js" defer></script>
    <style>
        :root {
            --sa-primary: #0d6efd;
            --sa-primary-dark: #0b5ed7;
        }
        body {
            background: #f5f7fb;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #1f2937;
        }
        .main-content { padding: 24px; }
        .card {
            border: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.06);
            border-radius: 14px;
            margin-bottom: 20px;
        }
        .status-badge {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-active { background: #e7f5ee; color: #0a7a43; }
        .status-inactive { background: #fdecec; color: #b42318; }
        .table > :not(caption) > * > * { vertical-align: middle; }
        .hidden { display: none !important; }
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.45);
            display: flex; align-items: center; justify-content: center;
            z-index: 1050;
        }
        .modal-card { background: #fff; border-radius: 16px; width: 100%; max-width: 860px; }
        .modal-header { padding: 16px 20px; border-bottom: 1px solid #eef2f7; }
        .modal-body { padding: 16px 20px; max-height: 70vh; overflow: auto; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid #eef2f7; display: flex; gap: 12px; justify-content: flex-end; }
        .form-label { font-weight: 600; color: #374151; }
        .section-title { font-weight: 700; margin-top: 10px; color: #111827; }

        /* --- Enhanced table visuals --- */
        .table thead th {
            font-weight: 700;
            color: #111827;
            border-bottom: 1px solid #eef2f7 !important;
        }
        .table-hover tbody tr:hover {
            background: #f9fafb;
        }
        /* Thumbnail and placeholder styling */
        .w-12 { width: 48px !important; }
        .h-12 { height: 48px !important; }
        .rounded-lg { border-radius: 12px !important; }
        .product-name { font-weight: 600; color: #111827; }
        .product-model { color: #6b7280; font-size: 0.875rem; }
        .table .w-12.h-12.rounded-lg { border: 1px solid #e5e7eb; background: #f8fafc; }
        .table .w-12.h-12.rounded-lg.text-muted { font-size: 10px; }

        /* Price display */
        .price-main { font-weight: 600; color: #111827; }
        .price-old { color: #9ca3af; text-decoration: line-through; font-size: 0.875rem; }

        /* Action buttons (map Tailwind-like classes used in JS to Bootstrap-friendly CSS) */
        .p-2 { padding: .5rem !important; }
        .text-blue-600 { color: #2563eb !important; }
        .text-red-600 { color: #dc2626 !important; }
        .text-gray-600 { color: #4b5563 !important; }
        .hover\:text-blue-800:hover { color: #1e40af !important; }
        .hover\:text-red-800:hover { color: #991b1b !important; }
        .hover\:text-gray-800:hover { color: #1f2937 !important; }
        .hover\:bg-blue-50:hover { background: #eff6ff !important; }
        .hover\:bg-red-50:hover { background: #fef2f2 !important; }
        .hover\:bg-gray-50:hover { background: #f9fafb !important; }

        /* Badges & chips */
        .badge-soft {
            background: #eef2ff;
            color: #3730a3;
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 12px;
        }

        /* Pagination area */
        #pagination { border-top: 1px solid #f1f5f9; background: #fff; border-radius: 0 0 14px 14px; }

        /* Image Upload Area */
        .image-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            background: #f9fafb;
            transition: background .2s ease-in-out, border-color .2s ease-in-out;
        }
        .image-upload-area:hover {
            background: #f3f4f6;
            border-color: var(--sa-primary);
        }
        .image-preview-container {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 16px;
        }
        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
        }
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .image-preview-item .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Sidebar will be loaded by sidebar-loader.js -->

    <!-- Main Content -->
    <div class="main-content">
        <header class="bg-white shadow-sm p-4 mb-4 rounded">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 fw-bold text-dark">Quản Lý Sản Phẩm</h1>
                    <p class="text-muted mb-0">Thêm, sửa, xóa và quản lý các sản phẩm</p>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span id="products-count" class="text-muted"></span>
                    <button id="add-product-btn" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Thêm Sản Phẩm
                    </button>
                </div>
            </div>
        </header>

        <div class="card p-4 mb-4">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" id="search-input" class="form-control" placeholder="Tìm kiếm sản phẩm...">
                </div>
                <div class="col-md-3">
                    <select id="category-filter" class="form-select">
                        <option value="">Tất cả danh mục</option>
                        <option value="solar-panels">Tấm Pin Mặt Trời</option>
                        <option value="inverters">Inverter</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="status-filter" class="form-select">
                        <option value="">Tất cả trạng thái</option>
                        <option value="true">Hoạt động</option>
                        <option value="false">Không hoạt động</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="apply-filters" class="btn btn-secondary w-100">Lọc</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div id="loading-state" class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="products-table" class="table-responsive d-none">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width:72px;">Hình</th>
                                <th>Sản Phẩm</th>
                                <th>Danh Mục</th>
                                <th>Giá</th>
                                <th>Tồn Kho</th>
                                <th>Trạng Thái</th>
                                <th>Ngày Tạo</th>
                                <th class="text-end">Thao Tác</th>
                            </tr>
                        </thead>
                        <tbody id="products-tbody"></tbody>
                    </table>
                </div>
                <div id="empty-state" class="text-center p-5 d-none">
                    <h4>Không có sản phẩm nào</h4>
                </div>
            </div>
            <div id="pagination" class="card-footer"></div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-header d-flex justify-content-between align-items-center">
                <h5 id="modal-title" class="mb-0">Thêm Sản Phẩm Mới</h5>
                <button id="close-modal" class="btn btn-light btn-sm"><i class="fas fa-times"></i></button>
            </div>
            <form id="product-form">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tên sản phẩm</label>
                            <input id="product-name" type="text" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Danh mục</label>
                            <select id="product-category" class="form-select" required>
                                <option value="">Chọn danh mục</option>
                                <option value="solar-panels">Tấm Pin Mặt Trời</option>
                                <option value="inverters">Inverter</option>
                                <option value="batteries">Pin Lưu Trữ</option>
                                <option value="mounting-systems">Hệ Thống Lắp Đặt</option>
                                <option value="monitoring">Giám Sát</option>
                                <option value="accessories">Phụ Kiện</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Thương hiệu</label>
                            <input id="product-brand" type="text" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Model</label>
                            <input id="product-model" type="text" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Giá bán</label>
                            <input id="product-price" type="number" min="0" step="0.01" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Giá gốc</label>
                            <input id="product-original-price" type="number" min="0" step="0.01" class="form-control">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Mô tả ngắn</label>
                            <input id="product-short-description" type="text" class="form-control">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Mô tả chi tiết</label>
                            <textarea id="product-description" rows="4" class="form-control"></textarea>
                        </div>

                        <div class="col-md-12">
                            <h6 class="section-title">Thông số kỹ thuật</h6>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Công suất</label>
                            <input id="spec-power" type="text" class="form-control" placeholder="Ví dụ: 550W">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Hiệu suất</label>
                            <input id="spec-efficiency" type="text" class="form-control" placeholder="Ví dụ: 21%">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Bảo hành</label>
                            <input id="spec-warranty" type="text" class="form-control" placeholder="Ví dụ: 12 năm">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Kích thước</label>
                            <input id="spec-dimensions" type="text" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Khối lượng</label>
                            <input id="spec-weight" type="text" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Chất liệu</label>
                            <input id="spec-material" type="text" class="form-control">
                        </div>

                        <div class="col-md-12 d-flex align-items-center gap-4">
                            <div class="form-check">
                                <input id="product-in-stock" class="form-check-input" type="checkbox">
                                <label class="form-check-label" for="product-in-stock">Còn hàng</label>
                            </div>
                            <div class="form-check">
                                <input id="product-featured" class="form-check-input" type="checkbox">
                                <label class="form-check-label" for="product-featured">Sản phẩm nổi bật</label>
                            </div>
                            <div class="ms-auto" style="max-width:220px;">
                                <label class="form-label">Số lượng tồn</label>
                                <input id="product-stock" type="number" min="0" class="form-control" value="0">
                            </div>
                        </div>

                        <div class="col-md-12">
                            <h6 class="section-title">Tính năng</h6>
                            <div id="features-container" class="d-flex flex-column gap-2">
                                <div class="flex d-flex gap-2">
                                    <input type="text" placeholder="Nhập tính năng..." class="form-control">
                                    <button type="button" onclick="addFeature()" class="btn btn-outline-primary">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <h6 class="section-title">Hình ảnh sản phẩm</h6>
                            <div id="image-upload-container">
                                <div id="image-upload-area" class="image-upload-area">
                                    <input type="file" id="product-images-input" multiple accept="image/*" class="d-none">
                                    <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                    <p class="mb-1"><strong>Kéo thả hoặc nhấn để chọn ảnh</strong></p>
                                    <p class="text-muted small mb-0" id="image-upload-text">Tối đa 5 ảnh, định dạng PNG, JPG, WEBP</p>
                                </div>
                                <div id="image-preview-container" class="image-preview-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="cancel-btn" class="btn btn-light">Hủy</button>
                    <button type="submit" id="save-btn" class="btn btn-primary">
                        <span class="loading-spinner spinner-border spinner-border-sm hidden" role="status" aria-hidden="true"></span>
                        <span id="save-btn-text">Lưu Sản Phẩm</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-overlay hidden">
        <div class="modal-card" style="max-width:520px;">
            <div class="modal-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Xóa sản phẩm</h5>
                <button id="cancel-delete" class="btn btn-light btn-sm"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc muốn xóa sản phẩm này? Hành động này sẽ ẩn sản phẩm khỏi hệ thống.</p>
            </div>
            <div class="modal-footer">
                <button id="cancel-delete-2" type="button" class="btn btn-light">Hủy</button>
                <button id="confirm-delete" type="button" class="btn btn-danger">Xóa</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/admin-products.js"></script>
    <script>
        // Map extra cancel button to the same handler ID expected by JS
        document.addEventListener('DOMContentLoaded', function() {
            const cancelDelete2 = document.getElementById('cancel-delete-2');
            if (cancelDelete2) {
                cancelDelete2.addEventListener('click', function(){
                    const btn = document.getElementById('cancel-delete');
                    if (btn) btn.click();
                });
            }
        });
    </script>
</body>
</html>
