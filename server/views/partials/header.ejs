<!-- Clean Modern Header with Animations -->
<header class="bg-white/95 backdrop-blur-md border-b border-gray-100 sticky top-0 z-50 animate-slideDown">
    <div class="max-w-7xl mx-auto px-6">
        <div class="flex items-center justify-between h-20">
            <!-- Logo with Enhanced Animation -->
            <a href="/" class="flex items-center gap-4 group animate-fadeInLeft">
                <img src="/assets/images/logo_rm_bgr.png" alt="SolarAnalytics Logo" class="w-12 h-12 group-hover:scale-110 transition-all duration-300">
                <div class="flex flex-col">
                    <span class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-green-600 bg-clip-text text-transparent group-hover:from-blue-700 group-hover:to-green-700 transition-all duration-300">SolarAnalytics</span>
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">NƒÇNG L∆Ø·ª¢NG M·∫∂T TR·ªúI</span>
                </div>
            </a>

            <!-- Navigation with Icons and Animations -->
            <nav class="hidden lg:flex items-center space-x-2 animate-fadeInUp">
                <a href="/" class="nav-item px-4 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-300 hover:scale-105 hover:shadow-md">
                    <i class="fas fa-home mr-2 text-sm"></i>Trang Ch·ªß
                </a>
                <a href="/products.html" class="nav-item px-4 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-300 hover:scale-105 hover:shadow-md">
                    <i class="fas fa-solar-panel mr-2 text-sm"></i>S·∫£n Ph·∫©m
                </a>
                <a href="/services.html" class="nav-item px-4 py-3 text-sm font-medium text-gray-700 hover:text-green-600 hover:bg-green-50 rounded-lg transition-all duration-300 hover:scale-105 hover:shadow-md">
                    <i class="fas fa-tools mr-2 text-sm"></i>D·ªãch V·ª•
                </a>
                <a href="/projects.html" class="nav-item px-4 py-3 text-sm font-medium text-gray-700 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-all duration-300 hover:scale-105 hover:shadow-md">
                    <i class="fas fa-project-diagram mr-2 text-sm"></i>D·ª± √Ån
                </a>
                <a href="/phan_tich.html" class="nav-item px-4 py-3 text-sm font-medium text-gray-700 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-all duration-300 hover:scale-105 hover:shadow-md">
                    <i class="fas fa-chart-line mr-2 text-sm"></i>Ph√¢n t√≠ch
                </a>
                <a href="/dashboard.html" class="nav-item px-4 py-3 text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all duration-300 hover:scale-105 hover:shadow-md">
                    <i class="fas fa-tachometer-alt mr-2 text-sm"></i>Dashboard
                </a>
            </nav>

            <!-- Auth Section with Animations -->
            <div class="flex items-center gap-4 animate-fadeInRight">
                <!-- Login/Register buttons (when not logged in) -->
                <div id="auth-buttons" class="flex items-center gap-4">
                    <a href="/login.html" class="px-5 py-2.5 text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-300 hover:scale-105 border border-gray-200 hover:border-blue-200">
                        <i class="fas fa-sign-in-alt mr-2 text-sm"></i>ƒêƒÉng nh·∫≠p
                    </a>
                    <a href="/register.html" class="px-5 py-2.5 text-sm font-medium bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-300 hover:scale-105 hover:shadow-lg">
                        <i class="fas fa-user-plus mr-2 text-sm"></i>ƒêƒÉng k√Ω
                    </a>
                </div>
            
                <!-- Profile Dropdown Button (when logged in) -->
                <div id="profile-dropdown" class="relative hidden">
                    <button onclick="toggleProfileDropdown()" class="flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-gray-50 transition-all duration-300 group hover:scale-105 border border-gray-100 hover:border-gray-200">
                        <img id="header-user-avatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzYiIGhlaWdodD0iMzYiIHZpZXdCb3g9IjAgMCAzNiAzNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjM2IiBoZWlnaHQ9IjM2IiByeD0iMTgiIGZpbGw9IiM0RjQ2RTUiLz4KPHRleHQgeD0iMTgiIHk9IjIyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmb250LXdlaWdodD0iYm9sZCI+VTwvdGV4dD4KPC9zdmc+Cg==" alt="User Avatar" class="w-9 h-9 rounded-full object-cover ring-2 ring-blue-100 group-hover:ring-blue-200 transition-all duration-300" onclick="navigateToProfile(event)">
                        <div class="hidden lg:flex flex-col items-start">
                            <span id="header-user-name" class="text-sm font-semibold text-gray-900 group-hover:text-blue-600 transition-colors cursor-pointer" onclick="navigateToProfile(event)">ƒêang t·∫£i...</span>
                            <span id="header-user-email" class="text-xs text-gray-500">user@example.com</span>
                        </div>
                        <i class="fas fa-chevron-down text-sm text-gray-400 group-hover:text-gray-600 transition-colors transform group-hover:rotate-180 duration-300"></i>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div id="profile-dropdown-menu" class="absolute right-0 top-full mt-2 w-64 bg-white rounded-xl shadow-lg border border-gray-100 py-2 z-50 hidden">
                        <!-- User Info Section -->
                        <div class="px-4 py-3 border-b border-gray-100">
                            <div class="flex items-center gap-3">
                                <img id="dropdown-user-avatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iMjAiIGZpbGw9IiM0RjQ2RTUiLz4KPHRleHQgeD0iMjAiIHk9IjI1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE4IiBmb250LXdlaWdodD0iYm9sZCI+VTwvdGV4dD4KPC9zdmc+Cg==" alt="User Avatar" class="w-10 h-10 rounded-full object-cover" onclick="navigateToProfile(event)">
                                <div class="flex-1">
                                    <p id="dropdown-user-name" class="font-medium text-gray-900 cursor-pointer hover:text-blue-600 transition-colors" onclick="navigateToProfile(event)">ƒêang t·∫£i...</p>
                                    <p id="dropdown-user-email" class="text-sm text-gray-500">user@example.com</p>
                                </div>
                            </div>
                        </div>

                        <!-- Menu Items -->
                        <div class="py-1">
                            <a href="/profile.html" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-all duration-300">
                                <i class="fas fa-user w-4 text-center"></i>
                                <span>H·ªì s∆° c√° nh√¢n</span>
                            </a>
                            <a href="/dashboard.html" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-all duration-300">
                                <i class="fas fa-tachometer-alt w-4 text-center"></i>
                                <span>Dashboard</span>
                            </a>
                            <a href="/lich_su.html" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-all duration-300">
                                <i class="fas fa-history w-4 text-center"></i>
                                <span>L·ªãch s·ª≠</span>
                            </a>
                            <div id="admin-link" class="hidden">
                                <a href="/admin" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition-all duration-300">
                                    <i class="fas fa-cog w-4 text-center"></i>
                                    <span>Qu·∫£n tr·ªã</span>
                                </a>
                            </div>
                        </div>

                        <!-- Logout Section -->
                        <div class="border-t border-gray-100 py-1">
                            <button onclick="logout()" class="flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50 hover:text-red-700 transition-all duration-300 w-full text-left">
                                <i class="fas fa-sign-out-alt w-4 text-center"></i>
                                <span>ƒêƒÉng xu·∫•t</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobile-menu-button" class="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-all duration-300" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars text-gray-600"></i>
                </button>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="lg:hidden bg-white border-t border-gray-200 hidden shadow-lg">
            <div class="px-6 py-4 space-y-1">
                <a href="/" class="block px-4 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-300">
                    <i class="fas fa-home mr-3 text-sm w-4"></i>Trang Ch·ªß
                </a>
                <a href="/products.html" class="block px-4 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-300">
                    <i class="fas fa-solar-panel mr-3 text-sm w-4"></i>S·∫£n Ph·∫©m
                </a>
                <a href="/services.html" class="block px-4 py-3 text-sm font-medium text-gray-700 hover:text-green-600 hover:bg-green-50 rounded-lg transition-all duration-300">
                    <i class="fas fa-tools mr-3 text-sm w-4"></i>D·ªãch V·ª•
                </a>
                <a href="/projects.html" class="block px-4 py-3 text-sm font-medium text-gray-700 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-all duration-300">
                    <i class="fas fa-project-diagram mr-3 text-sm w-4"></i>D·ª± √Ån
                </a>
                <a href="/phan_tich.html" class="block px-4 py-3 text-sm font-medium text-gray-700 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-all duration-300">
                    <i class="fas fa-chart-line mr-3 text-sm w-4"></i>Ph√¢n t√≠ch
                </a>
                <a href="/dashboard.html" class="block px-4 py-3 text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all duration-300">
                    <i class="fas fa-tachometer-alt mr-3 text-sm w-4"></i>Dashboard
                </a>
            </div>
        </div>
    </div>
</header>

<!-- CSS Animations -->
<style>
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeInLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeInRight {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .animate-slideDown {
        animation: slideDown 0.8s ease-out;
    }

    .animate-fadeInLeft {
        animation: fadeInLeft 0.8s ease-out 0.2s both;
    }

    .animate-fadeInUp {
        animation: fadeInUp 0.8s ease-out 0.4s both;
    }

    .animate-fadeInRight {
        animation: fadeInRight 0.8s ease-out 0.6s both;
    }

    /* Smooth transitions for all interactive elements */
    .nav-item {
        position: relative;
        overflow: hidden;
    }

    .nav-item::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 2px;
        background: linear-gradient(90deg, #3B82F6, #10B981);
        transition: width 0.3s ease;
    }

    .nav-item:hover::before {
        width: 100%;
    }

    /* Profile dropdown animations */
    #profile-dropdown-menu {
        transform: translateY(-10px);
        transition: all 0.3s ease;
    }

    #profile-dropdown-menu.show {
        transform: translateY(0);
    }

    /* Mobile menu animations */
    #mobile-menu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    #mobile-menu.show {
        max-height: 400px;
    }
</style>

<!-- JavaScript for Header Functionality -->
<script>
    // Enhanced authentication handling for EJS header
    function initializeEJSHeaderAuth() {
        console.log('üîÑ Initializing EJS Header Authentication...');
        
        // Check authentication state
        const userInfo = localStorage.getItem('userInfo');
        const token = localStorage.getItem('token');
        
        const authButtons = document.getElementById('auth-buttons');
        const profileDropdown = document.getElementById('profile-dropdown');
        
        if (!authButtons || !profileDropdown) {
            console.warn('‚ö†Ô∏è Auth elements not found, retrying...');
            setTimeout(initializeEJSHeaderAuth, 200);
            return;
        }
        
        // Check if user is logged in
        if (userInfo || token) {
            try {
                let userData = null;
                
                if (userInfo) {
                    userData = JSON.parse(userInfo);
                }
                
                // Validate authentication
                if (validateAuth(userData, token)) {
                    showUserProfile(userData, authButtons, profileDropdown);
                } else {
                    clearAuthData();
                    showLoginButtons(authButtons, profileDropdown);
                }
            } catch (error) {
                console.error('‚ùå Auth parsing error:', error);
                clearAuthData();
                showLoginButtons(authButtons, profileDropdown);
            }
        } else {
            showLoginButtons(authButtons, profileDropdown);
        }
    }
    
    // Validate authentication data
    function validateAuth(userData, token) {
        const hasToken = (userData && userData.token) || token;
        if (!hasToken) return false;
        
        // Check for user data
        if (userData && (userData.user || userData.name)) {
            return true;
        }
        
        return false;
    }
    
    // Show user profile in header
    function showUserProfile(userData, authButtons, profileDropdown) {
        console.log('‚úÖ Showing user profile');
        
        // Hide login buttons
        if (authButtons) {
            authButtons.style.display = 'none';
            authButtons.classList.add('hidden');
        }
        
        // Show profile dropdown
        if (profileDropdown) {
            profileDropdown.style.display = 'flex';
            profileDropdown.classList.remove('hidden');
        }
        
        // Update profile information
        updateProfileInfo(userData);
    }
    
    // Show login buttons
    function showLoginButtons(authButtons, profileDropdown) {
        console.log('‚úÖ Showing login buttons');
        
        // Show login buttons
        if (authButtons) {
            authButtons.style.display = 'flex';
            authButtons.classList.remove('hidden');
        }
        
        // Hide profile dropdown
        if (profileDropdown) {
            profileDropdown.style.display = 'none';
            profileDropdown.classList.add('hidden');
        }
    }
    
    // Update profile information
    function updateProfileInfo(userData) {
        const user = userData.user || userData;
        const userName = user.name || user.username || 'User';
        const userEmail = user.email || 'user@example.com';
        
        // Generate avatar initials
        const initials = userName.charAt(0).toUpperCase();
        const avatarSVG = generateAvatarSVG(initials);
        
        // Update header elements
        const elements = {
            'header-user-name': userName,
            'header-user-email': userEmail,
            'dropdown-user-name': userName,
            'dropdown-user-email': userEmail
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        });
        
        // Update avatars
        ['header-user-avatar', 'dropdown-user-avatar'].forEach(id => {
            const avatar = document.getElementById(id);
            if (avatar) {
                avatar.src = user.profileImage || avatarSVG;
                avatar.onerror = () => {
                    avatar.src = avatarSVG;
                };
            }
        });
        
        console.log('‚úÖ Profile info updated:', userName);
    }
    
    // Generate avatar SVG
    function generateAvatarSVG(initials, size = 32) {
        const svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" xmlns="http://www.w3.org/2000/svg">
            <rect width="${size}" height="${size}" rx="${size/2}" fill="#4F46E5"/>
            <text x="${size/2}" y="${size/2 + 6}" text-anchor="middle" fill="white" font-family="Arial" font-size="${size * 0.45}" font-weight="bold">${initials}</text>
        </svg>`;
        return `data:image/svg+xml;base64,${btoa(svg)}`;
    }
    
    // Clear authentication data
    function clearAuthData() {
        localStorage.removeItem('userInfo');
        localStorage.removeItem('token');
        localStorage.removeItem('user');
    }
    
    // Profile dropdown toggle
    function toggleProfileDropdown() {
        const menu = document.getElementById('profile-dropdown-menu');
        if (menu) {
            menu.classList.toggle('hidden');
            menu.classList.toggle('show');
            
            // Rotate chevron
            const chevron = document.querySelector('#profile-dropdown .fa-chevron-down');
            if (chevron) {
                const isOpen = !menu.classList.contains('hidden');
                chevron.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
            }
        }
    }

    // Mobile menu toggle
    function toggleMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        if (menu) {
            menu.classList.toggle('hidden');
            menu.classList.toggle('show');
        }
    }

    // Navigate to profile
    function navigateToProfile(event) {
        event.stopPropagation();
        
        // Check authentication before navigation
        const userInfo = localStorage.getItem('userInfo');
        const token = localStorage.getItem('token');
        
        if (!userInfo && !token) {
            showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem profile', 'warning');
            setTimeout(() => {
                window.location.href = '/login.html';
            }, 1000);
            return;
        }
        
        window.location.href = '/profile.html';
    }

    // Logout function
    function logout() {
        console.log('üö™ Logging out...');
        
        // Clear all authentication data
        clearAuthData();
        
        // Show notification
        showNotification('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng', 'success');
        
        // Reinitialize header to show login buttons
        setTimeout(() => {
            initializeEJSHeaderAuth();
        }, 500);
        
        // Redirect to login
        setTimeout(() => {
            window.location.href = '/login.html';
        }, 1500);
    }
    
    // Show notification
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : 
                       type === 'error' ? 'bg-red-500' : 
                       type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
        
        const icon = type === 'success' ? 'fa-check' : 
                    type === 'error' ? 'fa-times' : 
                    type === 'warning' ? 'fa-exclamation' : 'fa-info';
        
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg text-white transform translate-x-full transition-transform duration-300 ${bgColor}`;
        notification.innerHTML = `
            <div class="flex items-center gap-2">
                <i class="fas ${icon} mr-2"></i>
                ${message}
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);
        
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 300);
        }, 3000);
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('profile-dropdown');
        const menu = document.getElementById('profile-dropdown-menu');
        
        if (dropdown && menu && !dropdown.contains(event.target)) {
            menu.classList.add('hidden');
            menu.classList.remove('show');
            
            // Reset chevron
            const chevron = document.querySelector('#profile-dropdown .fa-chevron-down');
            if (chevron) {
                chevron.style.transform = 'rotate(0deg)';
            }
        }
    });

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ EJS Header DOM Ready');
        
        // Initialize authentication with delay to ensure elements are rendered
        setTimeout(initializeEJSHeaderAuth, 100);
        
        // Dispatch custom event for compatibility
        const headerLoadedEvent = new CustomEvent('headerLoaded');
        document.dispatchEvent(headerLoadedEvent);
    });
    
    // Listen for storage changes (login/logout from other tabs)
    window.addEventListener('storage', function(e) {
        if (e.key === 'userInfo' || e.key === 'token') {
            console.log('üîÑ Storage changed, reinitializing auth...');
            setTimeout(initializeEJSHeaderAuth, 100);
        }
    });
    
    // Expose functions globally for compatibility
    window.toggleProfileDropdown = toggleProfileDropdown;
    window.toggleMobileMenu = toggleMobileMenu;
    window.navigateToProfile = navigateToProfile;
    window.logout = logout;
</script>
