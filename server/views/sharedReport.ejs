<!-- File: server/views/sharedReport.ejs -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o c√°o Ph√¢n t√≠ch - <%= report.survey.name %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
        }
        
        * {
            font-family: 'Be Vietnam Pro', sans-serif;
        }
        
        /* Enhanced text readability */
        h1, h2, h3, h4, h5, h6 {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: -0.025em;
        }
        
        p, span, div {
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            background: #ffffff;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(240, 240, 240, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(250, 250, 250, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(245, 245, 245, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .modern-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(200, 200, 200, 0.3);
            border-radius: 24px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modern-container:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(200, 200, 200, 0.3);
            border-radius: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .stat-card:hover::before {
            left: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(200, 200, 200, 0.2);
            transition: background 0.2s ease;
        }
        
        .stat-item:hover {
            background: rgba(240, 240, 240, 0.3);
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: rgba(0, 0, 0, 0.8);
            font-size: 0.875rem;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
        }
        
        .stat-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #000000;
            text-shadow: 0 1px 3px rgba(255, 255, 255, 0.3);
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(200, 200, 200, 0.3);
            border-radius: 20px;
            padding: 2rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .chart-container:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        .modern-btn {
            background: var(--primary-gradient);
            border: none;
            border-radius: 50px;
            padding: 12px 32px;
            font-weight: 600;
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .modern-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .modern-btn:hover::before {
            left: 100%;
        }
        
        .modern-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .floating-elements {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        
        .floating-elements::before,
        .floating-elements::after {
            content: '';
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: float 8s ease-in-out infinite;
        }
        
        .floating-elements::before {
            top: 10%;
            right: 10%;
            animation-delay: -2s;
        }
        
        .floating-elements::after {
            bottom: 10%;
            left: 10%;
            animation-delay: -4s;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-30px) rotate(120deg); }
            66% { transform: translateY(30px) rotate(240deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.6s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            .modern-container {
                margin: 1rem;
                border-radius: 16px;
            }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Nh√∫ng Header v√†o ƒë√¢y -->
    <%- include('partials/header') %>

    <main class="p-4 sm:p-8 relative">
        <div class="floating-elements"></div>
        <div class="max-w-7xl mx-auto relative z-10">
            <div id="report-content" class="fade-in">
                <!-- D·ªØ li·ªáu ƒë∆∞·ª£c nh√∫ng tr·ª±c ti·∫øp b·∫±ng EJS -->
                <% const mainScenario = report.scenarios[0]; %>
                <% const formatCurrency = (value) => (value || 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }); %>
                
                <!-- Modern Header Section -->
                <div class="modern-container p-8 mb-8 slide-up">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                        <div class="flex-1">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-4">
                                    <i class="fas fa-chart-line text-white text-xl"></i>
                                </div>
                                <h1 class="text-4xl font-bold text-black drop-shadow-lg">üìä B√°o C√°o Ph√¢n T√≠ch ƒê·∫ßu T∆∞</h1>
                            </div>
                            <div class="space-y-2">
                                <p class="text-xl text-black drop-shadow-md">
                                    <i class="fas fa-user mr-2 text-blue-300"></i>
                                    Kh√°ch h√†ng: <span class="font-bold text-gray-800 drop-shadow-sm"><%= report.survey.name %></span>
                                </p>
                                <p class="text-black/90 drop-shadow-sm">
                                    <i class="fas fa-calendar mr-2 text-green-200"></i>
                                    Ng√†y t·∫°o: <span class="font-semibold"><%= new Date(report.createdAt).toLocaleString('vi-VN') %></span>
                                </p>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="export-pdf-btn" class="modern-btn bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600">
                                <i class="fas fa-file-pdf"></i>
                                <span>üìÑ T·∫£i PDF</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Complete Customer Information Section -->
                <div class="modern-container p-8 mb-8 slide-up" style="animation-delay: 0.1s">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-user-circle text-white text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-black drop-shadow-lg">üë§ Th√¥ng tin kh√°ch h√†ng</h2>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="stat-card p-6">
                            <div class="space-y-1">
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-user mr-2 text-blue-400"></i>
                                        T√™n kh√°ch h√†ng:
                                    </span>
                                    <span class="stat-value"><%= report.survey.name || 'Ch∆∞a cung c·∫•p' %></span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-phone mr-2 text-green-400"></i>
                                        S·ªë ƒëi·ªán tho·∫°i:
                                    </span>
                                    <span class="stat-value"><%= report.survey.phone || 'Ch∆∞a cung c·∫•p' %></span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-envelope mr-2 text-purple-400"></i>
                                        Email:
                                    </span>
                                    <span class="stat-value"><%= report.survey.email || 'Ch∆∞a cung c·∫•p' %></span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card p-6">
                            <div class="space-y-1">
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-map-marker-alt mr-2 text-red-400"></i>
                                        ƒê·ªãa ch·ªâ:
                                    </span>
                                    <span class="stat-value"><%= report.survey.address || 'Ch∆∞a cung c·∫•p' %></span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-building mr-2 text-orange-400"></i>
                                        Lo·∫°i kh√°ch h√†ng:
                                    </span>
                                    <span class="stat-value"><%= report.survey.customerType || 'Ch∆∞a x√°c ƒë·ªãnh' %></span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-globe mr-2 text-cyan-400"></i>
                                        Khu v·ª±c:
                                    </span>
                                    <span class="stat-value"><%= report.survey.region || 'Ch∆∞a x√°c ƒë·ªãnh' %></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Consumption Parameters Section -->
                <div class="modern-container p-8 mb-8 slide-up" style="animation-delay: 0.2s">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-bolt text-white text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-black drop-shadow-lg">üí° Th√¥ng s·ªë Ti√™u th·ª•</h2>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="stat-card p-6">
                            <div class="space-y-1">
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-calendar-alt mr-2 text-blue-400"></i>
                                        Ti√™u th·ª• ƒëi·ªán/th√°ng:
                                    </span>
                                    <span class="stat-value"><%= mainScenario.inputs.monthlyKwh || 'N/A' %> kWh</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-money-bill-wave mr-2 text-green-400"></i>
                                        H√≥a ƒë∆°n ƒëi·ªán/th√°ng:
                                    </span>
                                    <span class="stat-value"><%= formatCurrency(mainScenario.inputs.monthlyBill || 0) %></span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-calendar mr-2 text-purple-400"></i>
                                        Ti√™u th·ª• ƒëi·ªán/nƒÉm:
                                    </span>
                                    <span class="stat-value"><%= ((mainScenario.inputs.monthlyKwh || 0) * 12).toFixed(0) %> kWh</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card p-6">
                            <div class="space-y-1">
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-sun mr-2 text-yellow-400"></i>
                                        T·ª∑ l·ªá s·ª≠ d·ª•ng ban ng√†y:
                                    </span>
                                    <span class="stat-value"><%= mainScenario.inputs.dayUsageRatio || 'N/A' %>%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-moon mr-2 text-indigo-400"></i>
                                        S·ª≠ d·ª•ng ban ƒë√™m:
                                    </span>
                                    <span class="stat-value"><%= (100 - (mainScenario.inputs.dayUsageRatio || 0)) %>%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-chart-line mr-2 text-cyan-400"></i>
                                        H√≥a ƒë∆°n ƒëi·ªán/nƒÉm:
                                    </span>
                                    <span class="stat-value"><%= formatCurrency((mainScenario.inputs.monthlyBill || 0) * 12) %></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System & Cost Specifications Section -->
                <div class="modern-container p-8 mb-8 slide-up" style="animation-delay: 0.3s">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-teal-500 rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-cogs text-white text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-black drop-shadow-lg">üîß Th√¥ng s·ªë H·ªá th·ªëng & Chi ph√≠</h2>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="stat-card p-6">
                            <div class="space-y-1">
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-solar-panel mr-2 text-blue-400"></i>
                                        C√¥ng su·∫•t t·∫•m pin:
                                    </span>
                                    <span class="stat-value"><%= mainScenario.inputs.panelWattage || 'N/A' %> Wp</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-money-check-alt mr-2 text-green-400"></i>
                                        Chi ph√≠ ƒë·∫ßu t∆∞/kWp:
                                    </span>
                                    <span class="stat-value"><%= formatCurrency(mainScenario.inputs.investmentCost || 0) %></span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-tools mr-2 text-purple-400"></i>
                                        Lo·∫°i h·ªá th·ªëng:
                                    </span>
                                    <span class="stat-value"><%= mainScenario.inputs.systemType || 'Grid-tie' %></span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card p-6">
                            <div class="space-y-1">
                                <% if (mainScenario.inputs.systemType === 'Hybrid') { %>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-battery-three-quarters mr-2 text-orange-400"></i>
                                        Chi ph√≠ l∆∞u tr·ªØ/kWh:
                                    </span>
                                    <span class="stat-value"><%= formatCurrency(mainScenario.inputs.storageInvestmentCost || 0) %></span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-warehouse mr-2 text-red-400"></i>
                                        Dung l∆∞·ª£ng pin c·∫ßn:
                                    </span>
                                    <span class="stat-value"><%= mainScenario.results.storageCapacity ? mainScenario.results.storageCapacity.toFixed(1) + ' kWh' : 'N/A' %></span>
                                </div>
                                <% } %>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-calculator mr-2 text-cyan-400"></i>
                                        T·ªïng ƒë·∫ßu t∆∞ d·ª± ki·∫øn:
                                    </span>
                                    <span class="stat-value text-red-300"><%= formatCurrency(mainScenario.results.totalInvestment || 0) %></span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-chart-pie mr-2 text-yellow-400"></i>
                                        Hi·ªáu qu·∫£ h·ªá th·ªëng:
                                    </span>
                                    <span class="stat-value">85%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- C·ªòT B√äN TR√ÅI -->
                    <div class="lg:col-span-1 space-y-8">
                        <!-- System Recommendations Card -->
                        <div class="stat-card p-6 slide-up" style="animation-delay: 0.1s">
                            <div class="flex items-center mb-6">
                                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-solar-panel text-white"></i>
                                </div>
                                <h2 class="text-xl font-bold text-black drop-shadow-lg">‚ö° H·ªá Th·ªëng ƒê·ªÅ Xu·∫•t</h2>
                            </div>
                            <div class="space-y-1">
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-bolt mr-2 text-yellow-400"></i>
                                        C√¥ng su·∫•t h·ªá th·ªëng:
                                    </span>
                                    <span class="stat-value"><%= mainScenario.results.recommendedKwp.toFixed(2) %> kWp</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-th mr-2 text-blue-400"></i>
                                        S·ªë t·∫•m pin:
                                    </span>
                                    <span class="stat-value"><%= mainScenario.results.numberOfPanels %> t·∫•m (<%= mainScenario.inputs.panelWattage %> Wp)</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-home mr-2 text-purple-400"></i>
                                        Di·ªán t√≠ch m√°i c·∫ßn:
                                    </span>
                                    <span class="stat-value"><%= mainScenario.results.requiredArea.toFixed(2) %> m¬≤</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Environmental Impact Card -->
                        <div class="stat-card p-6 slide-up" style="animation-delay: 0.2s">
                            <div class="flex items-center mb-6">
                                <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-leaf text-white"></i>
                                </div>
                                <h2 class="text-xl font-bold text-black drop-shadow-lg">üå± T√°c ƒê·ªông M√¥i Tr∆∞·ªùng</h2>
                            </div>
                            <div class="space-y-1">
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-cloud mr-2 text-green-400"></i>
                                        Gi·∫£m th·∫£i CO‚ÇÇ:
                                    </span>
                                    <span class="stat-value text-green-200 drop-shadow-sm"><%= mainScenario.results.co2ReductionYearly.toFixed(2) %> t·∫•n/nƒÉm</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">
                                        <i class="fas fa-tree mr-2 text-emerald-400"></i>
                                        T∆∞∆°ng ƒë∆∞∆°ng tr·ªìng:
                                    </span>
                                    <span class="stat-value text-emerald-200 drop-shadow-sm"><%= Math.round(mainScenario.results.treeEquivalent) %> c√¢y xanh</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- C·ªòT B√äN PH·∫¢I -->
                    <div class="lg:col-span-2 space-y-8">
                        <!-- Financial Analysis Card -->
                        <div class="stat-card p-6 slide-up" style="animation-delay: 0.3s">
                            <div class="flex items-center mb-6">
                                <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-chart-pie text-white"></i>
                                </div>
                                <h2 class="text-xl font-bold text-black drop-shadow-lg">üí∞ Ph√¢n T√≠ch T√†i Ch√≠nh</h2>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="stat-item bg-gradient-to-r from-red-500/20 to-pink-500/20 rounded-xl border border-red-500/30">
                                    <span class="stat-label">
                                        <i class="fas fa-money-bill-wave mr-2 text-red-400"></i>
                                        T·ªïng chi ph√≠ ƒë·∫ßu t∆∞:
                                    </span>
                                    <span class="stat-value text-red-200 drop-shadow-sm"><%= formatCurrency(mainScenario.results.totalInvestment) %></span>
                                </div>
                                <div class="stat-item bg-gradient-to-r from-green-500/20 to-emerald-500/20 rounded-xl border border-green-500/30">
                                    <span class="stat-label">
                                        <i class="fas fa-piggy-bank mr-2 text-green-400"></i>
                                        Ti·∫øt ki·ªám/th√°ng:
                                    </span>
                                    <span class="stat-value text-green-200 drop-shadow-sm"><%= formatCurrency(mainScenario.results.monthlySavings) %></span>
                                </div>
                                <div class="stat-item bg-gradient-to-r from-blue-500/20 to-cyan-500/20 rounded-xl border border-blue-500/30">
                                    <span class="stat-label">
                                        <i class="fas fa-clock mr-2 text-blue-400"></i>
                                        Th·ªùi gian ho√†n v·ªën:
                                    </span>
                                    <span class="stat-value text-blue-200 drop-shadow-sm"><%= mainScenario.results.paybackPeriodYears.toFixed(1) %> nƒÉm</span>
                                </div>
                                <div class="stat-item bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-xl border border-purple-500/30">
                                    <span class="stat-label">
                                        <i class="fas fa-percentage mr-2 text-purple-400"></i>
                                        ROI (NƒÉm ƒë·∫ßu):
                                    </span>
                                    <span class="stat-value text-purple-300"><%= mainScenario.results.roiFirstYear.toFixed(1) %>%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Monthly Bill Comparison Chart -->
                        <div class="chart-container slide-up" style="animation-delay: 0.4s">
                            <div class="flex items-center mb-6">
                                <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-chart-bar text-white"></i>
                                </div>
                                <h3 class="text-xl font-bold text-black drop-shadow-lg">üìä So S√°nh Chi Ph√≠ ƒêi·ªán H√†ng Th√°ng</h3>
                            </div>
                            <div class="h-64 bg-white/10 rounded-xl p-4">
                                <canvas id="billChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Payback Analysis Chart -->
                        <div class="chart-container slide-up" style="animation-delay: 0.5s">
                            <div class="flex items-center mb-6">
                                <div class="w-10 h-10 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-chart-line text-white"></i>
                                </div>
                                <h3 class="text-xl font-bold text-black drop-shadow-lg">üìà Ph√¢n T√≠ch D√≤ng Ti·ªÅn & Ho√†n V·ªën</h3>
                            </div>
                            <div class="h-80 bg-white/10 rounded-xl p-4">
                                <canvas id="paybackChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Nh√∫ng Footer v√†o ƒë√¢y -->
    <%- include('partials/footer') %>

    <!-- SCRIPT ƒê·ªÇ V·∫º BI·ªÇU ƒê·ªí HI·ªÜN ƒê·∫†I -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // L·∫•y d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c server nh√∫ng v√†o trang
            const results = <%- JSON.stringify(mainScenario.results) %>;
            const inputs = <%- JSON.stringify(mainScenario.inputs) %>;
            const totalInvestment = results.totalInvestment;
            const annualSavings = results.annualSavings;

            /**
             * V·∫Ω bi·ªÉu ƒë·ªì so s√°nh chi ph√≠ ƒëi·ªán hi·ªán ƒë·∫°i v·ªõi gradient v√† animation
             * @param {number} originalBill - Ti·ªÅn ƒëi·ªán ban ƒë·∫ßu
             * @param {number} newBill - Ti·ªÅn ƒëi·ªán sau khi l·∫Øp
             */
            function createBillChart(originalBill, newBill) {
                const ctx = document.getElementById('billChart')?.getContext('2d');
                if (!ctx) return;

                // ƒê·∫£m b·∫£o d·ªØ li·ªáu h·ª£p l·ªá
                const validOriginalBill = Math.max(0, originalBill || 0);
                const validNewBill = Math.max(0, newBill || 0);
                
                console.log('Creating bill chart with:', { validOriginalBill, validNewBill });

                // T·∫°o gradient cho c√°c c·ªôt
                const redGradient = ctx.createLinearGradient(0, 0, 0, 400);
                redGradient.addColorStop(0, 'rgba(239, 68, 68, 0.8)');
                redGradient.addColorStop(0.5, 'rgba(220, 38, 127, 0.6)');
                redGradient.addColorStop(1, 'rgba(157, 23, 77, 0.4)');

                const greenGradient = ctx.createLinearGradient(0, 0, 0, 400);
                greenGradient.addColorStop(0, 'rgba(34, 197, 94, 0.8)');
                greenGradient.addColorStop(0.5, 'rgba(16, 185, 129, 0.6)');
                greenGradient.addColorStop(1, 'rgba(5, 150, 105, 0.4)');

                const savings = validOriginalBill - validNewBill;
                const savingsPercent = validOriginalBill > 0 ? ((savings / validOriginalBill) * 100).toFixed(1) : 0;

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['üî¥ Tr∆∞·ªõc khi l·∫Øp', 'üü¢ Sau khi l·∫Øp'],
                        datasets: [{
                            label: 'Chi ph√≠ ƒëi·ªán h√†ng th√°ng',
                            data: [validOriginalBill, validNewBill],
                            backgroundColor: [redGradient, greenGradient],
                            borderColor: ['rgba(239, 68, 68, 1)', 'rgba(34, 197, 94, 1)'],
                            borderWidth: 2,
                            borderRadius: 12,
                            borderSkipped: false,
                            barThickness: 80,
                            maxBarThickness: 100
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 2000,
                            easing: 'easeInOutQuart'
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#374151',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1,
                                cornerRadius: 12,
                                displayColors: false,
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label.replace(/üî¥|üü¢/g, '').trim();
                                    },
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const formatted = value.toLocaleString('vi-VN') + ' VNƒê';
                                        if (context.dataIndex === 1) {
                                            return [
                                                `Chi ph√≠: ${formatted}`,
                                                `üí∞ Ti·∫øt ki·ªám: ${savings.toLocaleString('vi-VN')} VNƒê`,
                                                `üìä Gi·∫£m: ${savingsPercent}%`
                                            ];
                                        }
                                        return `Chi ph√≠: ${formatted}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#374151',
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(156, 163, 175, 0.2)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#6B7280',
                                    font: {
                                        size: 11
                                    },
                                    callback: function(value) {
                                        if (value >= 1000000) {
                                            return (value / 1000000).toFixed(1) + 'tr';
                                        } else if (value >= 1000) {
                                            return (value / 1000).toFixed(0) + 'k';
                                        }
                                        return value.toLocaleString('vi-VN');
                                    }
                                }
                            }
                        }
                    }
                });
            }

            /**
             * V·∫Ω bi·ªÉu ƒë·ªì ph√¢n t√≠ch d√≤ng ti·ªÅn v√† ho√†n v·ªën hi·ªán ƒë·∫°i v·ªõi gradient v√† animation
             * @param {number} totalInvestment - T·ªïng chi ph√≠ ƒë·∫ßu t∆∞
             * @param {number} annualSavings - Ti·ªÅn ti·∫øt ki·ªám h√†ng nƒÉm
             */
            function createPaybackChart(totalInvestment, annualSavings) {
                const ctx = document.getElementById('paybackChart')?.getContext('2d');
                if (!ctx) return;

                if (totalInvestment <= 0 || annualSavings <= 0) {
                    return;
                }
                
                // T√≠nh to√°n d·ªØ li·ªáu th√¥ng minh h∆°n
                const paybackYears = Math.ceil(totalInvestment / annualSavings);
                const maxYears = Math.max(15, paybackYears + 5);
                const years = Array.from({length: maxYears + 1}, (_, i) => i);
                const yearLabels = years.map(i => i === 0 ? 'B·∫Øt ƒë·∫ßu' : `NƒÉm ${i}`);
                const cashFlow = years.map(i => (annualSavings * i) - totalInvestment);
                
                // T·∫°o gradient cho v√πng √¢m v√† d∆∞∆°ng
                const negativeGradient = ctx.createLinearGradient(0, 0, 0, 400);
                negativeGradient.addColorStop(0, 'rgba(239, 68, 68, 0.3)');
                negativeGradient.addColorStop(1, 'rgba(239, 68, 68, 0.05)');
                
                const positiveGradient = ctx.createLinearGradient(0, 0, 0, 400);
                positiveGradient.addColorStop(0, 'rgba(34, 197, 94, 0.4)');
                positiveGradient.addColorStop(1, 'rgba(34, 197, 94, 0.05)');

                // T·∫°o gradient cho ƒë∆∞·ªùng line
                const lineGradient = ctx.createLinearGradient(0, 0, ctx.canvas.width, 0);
                lineGradient.addColorStop(0, 'rgba(239, 68, 68, 1)');
                lineGradient.addColorStop(0.5, 'rgba(168, 85, 247, 1)');
                lineGradient.addColorStop(1, 'rgba(34, 197, 94, 1)');

                // T√¨m ƒëi·ªÉm h√≤a v·ªën
                const breakEvenIndex = cashFlow.findIndex(value => value >= 0);
                const breakEvenYear = breakEvenIndex > 0 ? breakEvenIndex : paybackYears;

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: yearLabels,
                        datasets: [
                            {
                                label: 'üí∞ D√≤ng ti·ªÅn t√≠ch l≈©y',
                                data: cashFlow,
                                borderColor: lineGradient,
                                backgroundColor: positiveGradient,
                                fill: {
                                    target: 'origin',
                                    above: positiveGradient,
                                    below: negativeGradient
                                },
                                borderWidth: 4,
                                tension: 0.4,
                                pointBackgroundColor: '#10B981',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 3,
                                pointRadius: 5,
                                pointHoverRadius: 7
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 2500,
                            easing: 'easeInOutCubic',
                            delay: 0
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#374151',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1,
                                cornerRadius: 12,
                                displayColors: false,
                                callbacks: {
                                    title: function(context) {
                                        const year = context[0].dataIndex;
                                        if (year === 0) return 'Th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu';
                                        if (year === breakEvenYear) return `üéØ NƒÉm ${year} - ƒêi·ªÉm h√≤a v·ªën`;
                                        return `NƒÉm ${year}`;
                                    },
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const year = context.dataIndex;
                                        const formatted = (value / 1000000).toFixed(1);
                                        const status = value < 0 ? 'üìâ Ch∆∞a ho√†n v·ªën' : 'üìà ƒê√£ c√≥ l√£i';
                                        
                                        if (year === breakEvenYear) {
                                            return [
                                                `${status}: ${formatted} tri·ªáu VNƒê`,
                                                `üéâ ƒê√¢y l√† ƒëi·ªÉm h√≤a v·ªën!`,
                                                `‚è∞ Ho√†n v·ªën sau ${breakEvenYear} nƒÉm`
                                            ];
                                        }
                                        
                                        const result = [`${status}: ${formatted} tri·ªáu VNƒê`];
                                        if (year > 0) {
                                            const totalSavings = annualSavings * year;
                                            const roi = ((totalSavings - totalInvestment) / totalInvestment * 100).toFixed(1);
                                            result.push(`üíµ T·ªïng ti·∫øt ki·ªám: ${(totalSavings / 1000000).toFixed(1)} tri·ªáu`);
                                            result.push(`üìä ROI: ${roi}%`);
                                        }
                                        return result;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(156, 163, 175, 0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#6B7280',
                                    font: {
                                        size: 11
                                    },
                                    maxTicksLimit: 10,
                                    callback: function(value, index) {
                                        if (index === 0) return 'B·∫Øt ƒë·∫ßu';
                                        return index % 2 === 0 ? `NƒÉm ${index}` : '';
                                    }
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(156, 163, 175, 0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#6B7280',
                                    font: {
                                        size: 11
                                    },
                                    callback: function(value) {
                                        const millions = value / 1000000;
                                        if (millions === 0) return '0 (H√≤a v·ªën)';
                                        return millions > 0 ? `+${millions.toFixed(0)}tr` : `${millions.toFixed(0)}tr`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // T√≠nh to√°n d·ªØ li·ªáu cho bi·ªÉu ƒë·ªì
            const originalBill = inputs.monthlyBill || 0;
            const monthlySavings = results.monthlySavings || 0;
            const newBill = Math.max(0, originalBill - monthlySavings);
            
            console.log('Chart data:', { originalBill, monthlySavings, newBill });

            // G·ªçi h√†m ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì
            createBillChart(originalBill, newBill);
            createPaybackChart(totalInvestment, annualSavings);

            // G·∫Øn s·ª± ki·ªán xu·∫•t PDF
            document.getElementById('export-pdf-btn').onclick = () => {
                 const reportElement = document.getElementById('report-content');
                 const customerName = "<%= report.survey.name.replace(/\\s/g, '_') %>";
                 const pdfButton = document.getElementById('export-pdf-btn');
                 pdfButton.style.display = 'none'; // T·∫°m ·∫©n n√∫t b·∫•m
                 html2canvas(reportElement, { scale: 2 }).then(canvas => {
                     const imgData = canvas.toDataURL('image/png');
                     const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                     const pdfWidth = pdf.internal.pageSize.getWidth();
                     const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                     pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                     pdf.save(`Bao_cao_${customerName}.pdf`);
                     pdfButton.style.display = 'flex'; // Hi·ªán l·∫°i n√∫t b·∫•m
                 });
            };
        });
    </script>
</body>
</html>
